# sync-terminal

## 1. 系统概述

本系统旨在同步 Mac 系统上的 .ssh 目录和 ~/bin 目录下的文件到 OSS 对象存储，实现自动检测更新、加密存储、权限同步和版本控制。系统采用简化的版本控制策略，保留所有版本，并使用时间戳和哈希值作为版本标识。

## 2. 系统架构

### 2.1 主要组件

1. 文件监控器
2. 文件同步器
3. 加密/解密模块
4. OSS 存储接口
5. 元数据管理器
6. 命令行界面 (CLI)
7. 配置管理器
8. 版本控制管理器
9. 一致性检查器

### 2.2 数据流

```
本地文件系统 <-> 文件监控器 <-> 文件同步器 <-> 加密/解密模块 <-> OSS 存储接口 <-> OSS
                                 ^              ^
                                 |              |
                            元数据管理器 <-> 版本控制管理器
                                 ^
                                 |
                            一致性检查器
                                 ^
                                 |
                             配置管理器
```

## 3. 详细组件设计

### 3.1 文件监控器

- 使用 FSEvents（macOS）监控 .ssh 和 ~/bin 目录
- 检测文件的创建、修改、删除事件
- 将检测到的事件放入事件队列

### 3.2 文件同步器

- 从事件队列中获取文件变更事件
- 调用元数据管理器比对文件状态
- 调用加密模块加密文件内容
- 通过 OSS 存储接口执行同步操作
- 更新元数据

### 3.3 加密/解密模块

- 使用 AES-256 算法进行对称加密
- 密钥管理：使用环境变量存储主密钥，派生文件特定的密钥
- 提供加密和解密方法

### 3.4 OSS 存储接口

- 封装 OSS SDK 的操作
- 提供上传、下载、列表、删除等基本操作
- 实现重试机制和错误处理
- 实现版本命名策略：文件路径_时间戳_哈希值

### 3.5 元数据管理器

- 使用 SQLite 数据库存储元数据
- 存储文件的 MD5 校验和、大小、修改时间、上传时间、权限、版本历史等信息
- 提供 CRUD 操作接口
- 实现数据库级别的事务支持

### 3.6 命令行界面 (CLI)

实现以下命令：
1. start：启动文件监控和自动同步
2. list：列出 OSS 上的所有文件及其版本
3. cat：查看指定文件内容（自动解密）
4. cp：将文件复制到本地（自动解密）
5. history：查看指定文件的版本历史
6. restore：恢复指定版本的文件
7. status：显示同步状态

### 3.7 配置管理器

- 使用 YAML 格式的配置文件存储 OSS 凭证、监控目录等信息
- 实现配置文件的加密存储
- 提供线程安全的配置读取接口

### 3.8 版本控制管理器

- 维护文件的完整版本历史
- 实现基于时间戳和哈希值的版本命名策略
- 提供版本列表和检索功能

### 3.9 一致性检查器

- 定期执行全量校验
- 比对本地文件系统、本地元数据和 OSS 存储的状态
- 解决检测到的不一致问题
- 生成一致性报告

## 4. 核心功能实现

### 4.1 文件同步逻辑

1. 文件监控器检测到变化
2. 文件同步器获取变更事件
3. 计算文件 MD5 和获取文件信息
4. 生成新的版本标识：文件路径_当前时间戳_哈希值
5. 加密文件内容
6. 上传新版本到 OSS
7. 更新元数据数据库，记录新版本信息

### 4.2 文件权限同步

- 在元数据数据库中存储文件权限信息
- 同步时，将权限信息作为元数据的一部分上传
- 下载或恢复文件时，根据元数据中的权限信息设置本地文件权限

### 4.3 版本控制

- 每次文件变更都创建新版本，不覆盖已有版本
- 使用 "文件路径_时间戳_哈希值" 作为 OSS 对象的 key
- 在元数据数据库中维护完整的版本历史
- 提供版本列表、检索和恢复功能

## 5. 数据一致性保证

### 5.1 OSS 并发控制

- 采用版本并存策略，每次更新创建新版本，避免并发写入冲突
- 在元数据数据库中记录所有版本信息
- 定期与 OSS 同步，确保元数据反映所有设备的更新

### 5.2 原子操作

- 利用 OSS 的原子性保证，每个版本的上传是一个原子操作
- 使用 OSS 的分片上传功能处理大文件，确保上传的完整性

### 5.3 最终一致性

- 接受 OSS 可能存在短暂的不一致状态
- 实现重试机制，在读取操作失败时等待一段时间后重试
- 定期执行一致性检查，比对本地状态和 OSS 状态

## 6. 安全考虑

- 使用 AES-256 算法加密文件内容
- 安全存储加密密钥和 OSS 凭证
- 使用 HTTPS 进行 OSS 通信
- 实现文件完整性校验机制
- 使用 OSS 的服务器端加密功能
- 实现客户端加密，确保数据在传输和存储过程中的端到端加密

## 7. 性能优化

- 使用多线程处理文件同步操作
- 实现本地缓存机制，减少对 OSS 的频繁访问
- 使用 OSS 的分片上传和断点续传功能处理大文件
- 优化数据库查询，使用适当的索引
- 实现智能清理策略，在存储空间受限时提示用户删除旧版本

## 8. 错误处理和日志

- 实现全面的错误处理机制
- 使用结构化日志记录系统操作和错误
- 实现日志轮转和归档
- 提供详细的调试模式

## 9. 用户体验

- 提供清晰的命令行界面
- 实现进度显示for长时间运行的操作
- 提供详细的状态报告和错误消息
- 允许用户轻松查看和管理文件版本

## 10. OSS 特定优化

- 合理设置 OSS 存储类型（标准、低频、归档等），优化存储成本
- 使用 OSS 的生命周期管理功能，可选择性地归档或删除非常旧的版本
- 根据版本的年龄自动调整存储类型，例如将旧版本转移到低频访问存储

## 11. 可扩展性考虑

- 设计模块化架构，便于添加新功能
- 预留用于支持多个 OSS 提供商的接口
- 为未来的 GUI 实现预留钩子

## 12. 测试策略

- 单元测试覆盖所有核心组件
- 集成测试验证组件间交互
- 压力测试评估系统在高负载下的表现
- 模拟各种网络条件和错误情况的测试

## 13. 部署和维护

- 提供简单的安装脚本
- 实现自动更新机制
- 提供系统健康检查工具
- 设计备份和恢复策略

## 14. 限制和注意事项

- 系统设计主要针对 Mac 环境，可能需要调整以支持其他操作系统
- 大量小文件可能会导致 OSS 存储成本增加，需要合理规划存储策略
- 频繁的文件更改可能导致版本数量快速增长，需要实现有效的版本管理策略


